apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.15.0
    component: create-user-job
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-create-user-job
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.15.0
    component: run-airflow-migrations
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-migrate-database-job
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.15.0
    component: scheduler
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-scheduler
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.15.0
    component: statsd
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-statsd
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.15.0
    component: triggerer
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-triggerer
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.15.0
    component: webserver
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-webserver
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.15.0
    component: worker
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-worker
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    chart: airflow-1.15.0
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-pod-launcher-role
  namespace: airflow
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - create
  - list
  - get
  - patch
  - watch
  - delete
- apiGroups:
  - ""
  resources:
  - pods/log
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - pods/exec
  verbs:
  - create
  - get
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    chart: airflow-1.15.0
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-pod-log-reader-role
  namespace: airflow
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - list
  - get
  - watch
- apiGroups:
  - ""
  resources:
  - pods/log
  verbs:
  - get
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    chart: airflow-1.15.0
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-pod-launcher-rolebinding
  namespace: airflow
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: airflow-pod-launcher-role
subjects:
- kind: ServiceAccount
  name: airflow-scheduler
  namespace: airflow
- kind: ServiceAccount
  name: airflow-worker
  namespace: airflow
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    chart: airflow-1.15.0
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-pod-log-reader-rolebinding
  namespace: airflow
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: airflow-pod-log-reader-role
subjects:
- kind: ServiceAccount
  name: airflow-webserver
  namespace: airflow
- kind: ServiceAccount
  name: airflow-triggerer
  namespace: airflow
---
apiVersion: v1
data:
  airflow.cfg: "[celery]\nflower_url_prefix = \nworker_concurrency = 16\n\n[celery_kubernetes_executor]\nkubernetes_queue
    = kubernetes\n\n[core]\ncolored_console_log = False\ndags_folder = /opt/airflow/dags/repo/dags\nexecutor
    = KubernetesExecutor\nload_examples = False\nremote_logging = False\n\n[elasticsearch]\njson_format
    = True\nlog_id_template = {dag_id}_{task_id}_{execution_date}_{try_number}\n\n[elasticsearch_configs]\nmax_retries
    = 3\nretry_timeout = True\ntimeout = 30\n\n[kerberos]\nccache = /var/kerberos-ccache/cache\nkeytab
    = /etc/airflow.keytab\nprincipal = airflow@FOO.COM\nreinit_frequency = 3600\n\n[kubernetes]\nairflow_configmap
    = airflow-config\nairflow_local_settings_configmap = airflow-config\nmulti_namespace_mode
    = False\nnamespace = airflow\npod_template_file = /opt/airflow/pod_templates/pod_template_file.yaml\nworker_container_repository
    = apache/airflow\nworker_container_tag = 2.9.3\n\n[kubernetes_executor]\nmulti_namespace_mode
    = False\nnamespace = airflow\npod_template_file = /opt/airflow/pod_templates/pod_template_file.yaml\nworker_container_repository
    = apache/airflow\nworker_container_tag = 2.9.3\n\n[logging]\ncolored_console_log
    = False\nremote_logging = False\n\n[metrics]\nstatsd_host = airflow-statsd\nstatsd_on
    = True\nstatsd_port = 9125\nstatsd_prefix = airflow\n\n[scheduler]\nrun_duration
    = 41460\nstandalone_dag_processor = False\nstatsd_host = airflow-statsd\nstatsd_on
    = True\nstatsd_port = 9125\nstatsd_prefix = airflow\n\n[triggerer]\ndefault_capacity
    = 1000\n\n[webserver]\nenable_proxy_fix = True\nrbac = True"
  airflow_local_settings.py: |2-

    from airflow.www.utils import UIAlert

    DASHBOARD_UIALERTS = [
      UIAlert(
        'Usage of a dynamic webserver secret key detected. We recommend a static webserver secret key instead.'
        ' See the <a href='
        '"https://airflow.apache.org/docs/helm-chart/stable/production-guide.html#webserver-secret-key" '
        'target="_blank" rel="noopener noreferrer">'
        'Helm Chart Production Guide</a> for more details.',
        category="warning",
        roles=["Admin"],
        html=True,
      )
    ]
  pod_template_file.yaml: "\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: placeholder-name\n
    \ labels:\n    tier: airflow\n    component: worker\n    release: airflow\n  annotations:\n
    \   cluster-autoscaler.kubernetes.io/safe-to-evict: \"false\"\nspec:\n  initContainers:\n
    \   \n    - name: git-sync-init\n      image: registry.k8s.io/git-sync/git-sync:v4.1.0\n
    \     imagePullPolicy: IfNotPresent\n      securityContext:\n        runAsUser:
    65533\n      envFrom:  \n        []\n      env:\n        - name: GIT_SSH_KEY_FILE\n
    \         value: \"/etc/git-secret/ssh\"\n        - name: GITSYNC_SSH_KEY_FILE\n
    \         value: \"/etc/git-secret/ssh\"\n        - name: GIT_SYNC_SSH\n          value:
    \"true\"\n        - name: GITSYNC_SSH\n          value: \"true\"\n        - name:
    GIT_KNOWN_HOSTS\n          value: \"false\"\n        - name: GITSYNC_SSH_KNOWN_HOSTS\n
    \         value: \"false\"\n        \n        - name: GIT_SYNC_REV\n          value:
    \"HEAD\"\n        - name: GITSYNC_REF\n          value: \"v2-2-stable\"\n        -
    name: GIT_SYNC_BRANCH\n          value: \"main\"\n        - name: GIT_SYNC_REPO\n
    \         value: \"https://github.com/ankiyong/seoul_traffic.git\"\n        -
    name: GITSYNC_REPO\n          value: \"https://github.com/ankiyong/seoul_traffic.git\"\n
    \       - name: GIT_SYNC_DEPTH\n          value: \"1\"\n        - name: GITSYNC_DEPTH\n
    \         value: \"1\"\n        - name: GIT_SYNC_ROOT\n          value: \"/git\"\n
    \       - name: GITSYNC_ROOT\n          value: \"/git\"\n        - name: GIT_SYNC_DEST\n
    \         value: \"repo\"\n        - name: GITSYNC_LINK\n          value: \"repo\"\n
    \       - name: GIT_SYNC_ADD_USER\n          value: \"true\"\n        - name:
    GITSYNC_ADD_USER\n          value: \"true\"\n        - name: GITSYNC_PERIOD\n
    \         value: \"5s\"\n        - name: GIT_SYNC_MAX_SYNC_FAILURES\n          value:
    \"0\"\n        - name: GITSYNC_MAX_FAILURES\n          value: \"0\"\n        -
    name: GIT_SYNC_ONE_TIME\n          value: \"true\"\n        - name: GITSYNC_ONE_TIME\n
    \         value: \"true\"\n      resources: \n        {}\n      volumeMounts:\n
    \     - name: dags\n        mountPath: /git\n      - name: git-sync-ssh-key\n
    \       mountPath: /etc/git-secret/ssh\n        readOnly: true\n        subPath:
    gitSshKey\n  containers:\n    - envFrom:      \n        []\n      env:\n        -
    name: AIRFLOW__CORE__EXECUTOR\n          value: LocalExecutor      \n        #
    Hard Coded Airflow Envs\n        - name: AIRFLOW__CORE__FERNET_KEY\n          valueFrom:\n
    \           secretKeyRef:\n              name: airflow-fernet-key\n              key:
    fernet-key\n        - name: AIRFLOW_HOME\n          value: /opt/airflow\n        #
    For Airflow <2.3, backward compatibility; moved to [database] in 2.3\n        -
    name: AIRFLOW__CORE__SQL_ALCHEMY_CONN\n          valueFrom:\n            secretKeyRef:\n
    \             name: airflow-metadata\n              key: connection\n        -
    name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN\n          valueFrom:\n            secretKeyRef:\n
    \             name: airflow-metadata\n              key: connection\n        -
    name: AIRFLOW_CONN_AIRFLOW_DB\n          valueFrom:\n            secretKeyRef:\n
    \             name: airflow-metadata\n              key: connection\n        -
    name: AIRFLOW__WEBSERVER__SECRET_KEY\n          valueFrom:\n            secretKeyRef:\n
    \             name: airflow-webserver-secret-key\n              key: webserver-secret-key
    \     \n        # Dynamically created environment variables\n        # Dynamically
    created secret envs\n        \n        # Extra env      \n      image: localhost:5000/airflow_python:latest\n
    \     imagePullPolicy: IfNotPresent\n      securityContext: \n        allowPrivilegeEscalation:
    false\n        capabilities:\n          drop:\n            - ALL\n      name:
    base\n      resources:\n        {}\n      volumeMounts:\n        - mountPath:
    \"/opt/airflow/logs\"\n          name: logs\n        - name: config\n          mountPath:
    \"/opt/airflow/airflow.cfg\"\n          subPath: airflow.cfg\n          readOnly:
    true\n        - name: config\n          mountPath: \"/opt/airflow/config/airflow_local_settings.py\"\n
    \         subPath: airflow_local_settings.py\n          readOnly: true\n        -
    name: dags\n          mountPath: /opt/airflow/dags\n          readOnly: True\n
    \ restartPolicy: Never\n  securityContext: \n    runAsUser: 50000\n    fsGroup:
    0\n  nodeSelector:\n    {}\n  affinity:\n    {}\n  terminationGracePeriodSeconds:
    600\n  tolerations:\n    []\n  topologySpreadConstraints:\n    []\n  serviceAccountName:
    airflow-worker\n  volumes:\n  - name: dags\n    emptyDir:\n      {}\n  - emptyDir:\n
    \     {}\n    name: logs\n  \n  - name: git-sync-ssh-key\n    secret:\n      secretName:
    airflow-git-ssh-secret\n      defaultMode: 288\n  - configMap:\n      name: airflow-config\n
    \   name: config"
kind: ConfigMap
metadata:
  labels:
    chart: airflow-1.15.0
    component: config
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-config
---
apiVersion: v1
data:
  mappings.yml: "# Licensed to the Apache Software Foundation (ASF) under one\n# or
    more contributor license agreements.  See the NOTICE file\n# distributed with
    this work for additional information\n# regarding copyright ownership.  The ASF
    licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\");
    you may not use this file except in compliance\n# with the License.  You may obtain
    a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n#
    Unless required by applicable law or agreed to in writing,\n# software distributed
    under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES
    OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for
    the\n# specific language governing permissions and limitations\n# under the License.\n---\n#
    \nmappings:\n  # Map dot separated stats to labels\n  - match: airflow.dagrun.dependency-check.*.*\n
    \   name: \"airflow_dagrun_dependency_check\"\n    labels:\n      dag_id: \"$1\"\n\n
    \ - match: airflow.operator_successes_(.*)\n    match_type: regex\n    name: \"airflow_operator_successes\"\n
    \   labels:\n      operator: \"$1\"\n\n  - match: airflow.operator_failures_(.*)\n
    \   match_type: regex\n    name: \"airflow_operator_failures\"\n    labels:\n
    \     operator: \"$1\"\n\n  - match: airflow.scheduler_heartbeat\n    match_type:
    regex\n    name: \"airflow_scheduler_heartbeat\"\n    labels:\n      type: counter\n\n
    \ - match: airflow.dag.*.*.duration\n    name: \"airflow_task_duration\"\n    labels:\n
    \     dag_id: \"$1\"\n      task_id: \"$2\"\n\n  - match: airflow.dagrun.duration.success.*\n
    \   name: \"airflow_dagrun_duration\"\n    labels:\n      dag_id: \"$1\"\n\n  -
    match: airflow.dagrun.duration.failed.*\n    name: \"airflow_dagrun_failed\"\n
    \   labels:\n      dag_id: \"$1\"\n\n  - match: airflow.dagrun.schedule_delay.*\n
    \   name: \"airflow_dagrun_schedule_delay\"\n    labels:\n      dag_id: \"$1\"\n\n
    \ - match: airflow.dag_processing.last_runtime.*\n    name: \"airflow_dag_processing_last_runtime\"\n
    \   labels:\n      dag_file: \"$1\"\n\n  - match: airflow.dag_processing.last_run.seconds_ago.*\n
    \   name: \"airflow_dag_processing_last_run_seconds_ago\"\n    labels:\n      dag_file:
    \"$1\"\n\n  - match: airflow.pool.open_slots.*\n    name: \"airflow_pool_open_slots\"\n
    \   labels:\n      pool: \"$1\"\n\n  - match: airflow.pool.used_slots.*\n    name:
    \"airflow_pool_used_slots\"\n    labels:\n      pool: \"$1\"\n\n  - match: airflow.pool.starving_tasks.*\n
    \   name: \"airflow_pool_starving_tasks\"\n    labels:\n      pool: \"$1\""
kind: ConfigMap
metadata:
  labels:
    chart: airflow-1.15.0
    component: config
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-statsd
---
apiVersion: v1
data:
  postgres-password: cG9zdGdyZXM=
kind: Secret
metadata:
  labels:
    app.kubernetes.io/instance: airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.1.0
    helm.sh/chart: postgresql-13.2.24
  name: airflow-postgresql
  namespace: airflow
type: Opaque
---
apiVersion: v1
data:
  connection: cmVkaXM6Ly86SDBBcFM3a1BUbUBhaXJmbG93LXJlZGlzOjYzNzkvMA==
kind: Secret
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    chart: airflow
    component: redis
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-broker-url
type: Opaque
---
apiVersion: v1
data:
  fernet-key: YTA5T1ZXZHZaWGg2UVVzM2F6UnBhM1ZSVEV4dGRtVndNRlI2VjB4d1ZXND0=
kind: Secret
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    chart: airflow
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-fernet-key
type: Opaque
---
apiVersion: v1
data:
  connection: cG9zdGdyZXNxbDovL3Bvc3RncmVzOnBvc3RncmVzQGFpcmZsb3ctcG9zdGdyZXNxbC5haXJmbG93OjU0MzIvcG9zdGdyZXM/c3NsbW9kZT1kaXNhYmxl
kind: Secret
metadata:
  labels:
    chart: airflow
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-metadata
type: Opaque
---
apiVersion: v1
data:
  password: SDBBcFM3a1BUbQ==
kind: Secret
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    chart: airflow
    component: redis
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-redis-password
type: Opaque
---
apiVersion: v1
data:
  webserver-secret-key: T1ROVGJUazRNV0YwVTFwaFdGTjZNRm96ZGtWVVFtUkhZVVp3YUc1RFYxYz0=
kind: Secret
metadata:
  labels:
    chart: airflow
    component: webserver
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-webserver-secret-key
type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.1.0
    helm.sh/chart: postgresql-13.2.24
  name: airflow-postgresql
  namespace: airflow
spec:
  ports:
  - name: tcp-postgresql
    nodePort: null
    port: 5432
    targetPort: tcp-postgresql
  selector:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: airflow
    app.kubernetes.io/name: postgresql
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
  labels:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.1.0
    helm.sh/chart: postgresql-13.2.24
  name: airflow-postgresql-hl
  namespace: airflow
spec:
  clusterIP: None
  ports:
  - name: tcp-postgresql
    port: 5432
    targetPort: tcp-postgresql
  publishNotReadyAddresses: true
  selector:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: airflow
    app.kubernetes.io/name: postgresql
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "9102"
    prometheus.io/scrape: "true"
  labels:
    chart: airflow-1.15.0
    component: statsd
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-statsd
spec:
  ports:
  - name: statsd-ingest
    port: 9125
    protocol: UDP
    targetPort: 9125
  - name: statsd-scrape
    port: 9102
    protocol: TCP
    targetPort: 9102
  selector:
    component: statsd
    release: airflow
    tier: airflow
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    chart: airflow-1.15.0
    component: triggerer
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-triggerer
spec:
  clusterIP: None
  ports:
  - name: triggerer-logs
    port: 8794
    protocol: TCP
    targetPort: 8794
  selector:
    component: triggerer
    release: airflow
    tier: airflow
---
apiVersion: v1
kind: Service
metadata:
  labels:
    chart: airflow-1.15.0
    component: webserver
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-webserver
spec:
  ports:
  - name: airflow-ui
    port: 8080
  selector:
    component: webserver
    release: airflow
    tier: airflow
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    chart: airflow-1.15.0
    component: scheduler
    executor: KubernetesExecutor
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-scheduler
spec:
  replicas: 1
  selector:
    matchLabels:
      component: scheduler
      release: airflow
      tier: airflow
  template:
    metadata:
      annotations:
        checksum/airflow-config: dc80aa0b8f9153165322df3c9b27cc36d75ad7f07eb5c06abe4f2f22f2490932
        checksum/extra-configmaps: e862ea47e13e634cf17d476323784fa27dac20015550c230953b526182f5cac8
        checksum/extra-secrets: e9582fdd622296c976cbc10a5ba7d6702c28a24fe80795ea5b84ba443a56c827
        checksum/metadata-secret: 1527346545415bf13f4c9ad69470086eb90d854f2b83594d78ec1badb5e13eb0
        checksum/pgbouncer-config-secret: 1dae2adc757473469686d37449d076b0c82404f61413b58ae68b3c5e99527688
        checksum/result-backend-secret: 98a68f230007cfa8f5d3792e1aff843a76b0686409e4a46ab2f092f6865a1b71
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
      labels:
        component: scheduler
        release: airflow
        tier: airflow
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: scheduler
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - args:
        - bash
        - -c
        - exec airflow scheduler
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: airflow-fernet-key
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: airflow-webserver-secret-key
        envFrom: []
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              CONNECTION_CHECK_MAX_COUNT=0 AIRFLOW__LOGGING__LOGGING_LEVEL=ERROR exec /entrypoint \
              airflow jobs check --job-type SchedulerJob --local
          failureThreshold: 5
          initialDelaySeconds: 10
          periodSeconds: 60
          timeoutSeconds: 20
        name: scheduler
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - |
              CONNECTION_CHECK_MAX_COUNT=0 AIRFLOW__LOGGING__LOGGING_LEVEL=ERROR exec /entrypoint \
              airflow jobs check --job-type SchedulerJob --local
          failureThreshold: 6
          periodSeconds: 10
          timeoutSeconds: 20
        volumeMounts:
        - mountPath: /opt/airflow/pod_templates/pod_template_file.yaml
          name: config
          readOnly: true
          subPath: pod_template_file.yaml
        - mountPath: /opt/airflow/logs
          name: logs
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
        - mountPath: /opt/airflow/dags
          name: dags
          readOnly: true
      - env:
        - name: GIT_SSH_KEY_FILE
          value: /etc/git-secret/ssh
        - name: GITSYNC_SSH_KEY_FILE
          value: /etc/git-secret/ssh
        - name: GIT_SYNC_SSH
          value: "true"
        - name: GITSYNC_SSH
          value: "true"
        - name: GIT_KNOWN_HOSTS
          value: "false"
        - name: GITSYNC_SSH_KNOWN_HOSTS
          value: "false"
        - name: GIT_SYNC_REV
          value: HEAD
        - name: GITSYNC_REF
          value: v2-2-stable
        - name: GIT_SYNC_BRANCH
          value: main
        - name: GIT_SYNC_REPO
          value: https://github.com/ankiyong/seoul_traffic.git
        - name: GITSYNC_REPO
          value: https://github.com/ankiyong/seoul_traffic.git
        - name: GIT_SYNC_DEPTH
          value: "1"
        - name: GITSYNC_DEPTH
          value: "1"
        - name: GIT_SYNC_ROOT
          value: /git
        - name: GITSYNC_ROOT
          value: /git
        - name: GIT_SYNC_DEST
          value: repo
        - name: GITSYNC_LINK
          value: repo
        - name: GIT_SYNC_ADD_USER
          value: "true"
        - name: GITSYNC_ADD_USER
          value: "true"
        - name: GITSYNC_PERIOD
          value: 5s
        - name: GIT_SYNC_MAX_SYNC_FAILURES
          value: "0"
        - name: GITSYNC_MAX_FAILURES
          value: "0"
        envFrom: []
        image: registry.k8s.io/git-sync/git-sync:v4.1.0
        imagePullPolicy: IfNotPresent
        name: git-sync
        resources: {}
        securityContext:
          runAsUser: 65533
        volumeMounts:
        - mountPath: /git
          name: dags
        - mountPath: /etc/git-secret/ssh
          name: git-sync-ssh-key
          readOnly: true
          subPath: gitSshKey
      - args:
        - bash
        - /clean-logs
        env:
        - name: AIRFLOW__LOG_RETENTION_DAYS
          value: "15"
        - name: AIRFLOW_HOME
          value: /opt/airflow
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        name: scheduler-log-groomer
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/logs
          name: logs
      initContainers:
      - args:
        - airflow
        - db
        - check-migrations
        - --migration-wait-timeout=60
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: airflow-fernet-key
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: airflow-webserver-secret-key
        envFrom: []
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        name: wait-for-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      - env:
        - name: GIT_SSH_KEY_FILE
          value: /etc/git-secret/ssh
        - name: GITSYNC_SSH_KEY_FILE
          value: /etc/git-secret/ssh
        - name: GIT_SYNC_SSH
          value: "true"
        - name: GITSYNC_SSH
          value: "true"
        - name: GIT_KNOWN_HOSTS
          value: "false"
        - name: GITSYNC_SSH_KNOWN_HOSTS
          value: "false"
        - name: GIT_SYNC_REV
          value: HEAD
        - name: GITSYNC_REF
          value: v2-2-stable
        - name: GIT_SYNC_BRANCH
          value: main
        - name: GIT_SYNC_REPO
          value: https://github.com/ankiyong/seoul_traffic.git
        - name: GITSYNC_REPO
          value: https://github.com/ankiyong/seoul_traffic.git
        - name: GIT_SYNC_DEPTH
          value: "1"
        - name: GITSYNC_DEPTH
          value: "1"
        - name: GIT_SYNC_ROOT
          value: /git
        - name: GITSYNC_ROOT
          value: /git
        - name: GIT_SYNC_DEST
          value: repo
        - name: GITSYNC_LINK
          value: repo
        - name: GIT_SYNC_ADD_USER
          value: "true"
        - name: GITSYNC_ADD_USER
          value: "true"
        - name: GITSYNC_PERIOD
          value: 5s
        - name: GIT_SYNC_MAX_SYNC_FAILURES
          value: "0"
        - name: GITSYNC_MAX_FAILURES
          value: "0"
        - name: GIT_SYNC_ONE_TIME
          value: "true"
        - name: GITSYNC_ONE_TIME
          value: "true"
        envFrom: []
        image: registry.k8s.io/git-sync/git-sync:v4.1.0
        imagePullPolicy: IfNotPresent
        name: git-sync-init
        resources: {}
        securityContext:
          runAsUser: 65533
        volumeMounts:
        - mountPath: /git
          name: dags
        - mountPath: /etc/git-secret/ssh
          name: git-sync-ssh-key
          readOnly: true
          subPath: gitSshKey
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: airflow-scheduler
      terminationGracePeriodSeconds: 10
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: airflow-config
        name: config
      - emptyDir: {}
        name: dags
      - name: git-sync-ssh-key
        secret:
          defaultMode: 288
          secretName: airflow-git-ssh-secret
      - emptyDir: {}
        name: logs
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    chart: airflow-1.15.0
    component: statsd
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-statsd
spec:
  replicas: 1
  selector:
    matchLabels:
      component: statsd
      release: airflow
      tier: airflow
  template:
    metadata:
      labels:
        component: statsd
        release: airflow
        tier: airflow
    spec:
      affinity: {}
      containers:
      - args:
        - --statsd.mapping-config=/etc/statsd-exporter/mappings.yml
        image: quay.io/prometheus/statsd-exporter:v0.26.1
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /metrics
            port: 9102
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
        name: statsd
        ports:
        - containerPort: 9125
          name: statsd-ingest
          protocol: UDP
        - containerPort: 9102
          name: statsd-scrape
        readinessProbe:
          httpGet:
            path: /metrics
            port: 9102
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /etc/statsd-exporter/mappings.yml
          name: config
          subPath: mappings.yml
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        runAsUser: 65534
      serviceAccountName: airflow-statsd
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: airflow-statsd
        name: config
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    chart: airflow-1.15.0
    component: webserver
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-webserver
spec:
  replicas: 1
  selector:
    matchLabels:
      component: webserver
      release: airflow
      tier: airflow
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      annotations:
        checksum/airflow-config: dc80aa0b8f9153165322df3c9b27cc36d75ad7f07eb5c06abe4f2f22f2490932
        checksum/extra-configmaps: e862ea47e13e634cf17d476323784fa27dac20015550c230953b526182f5cac8
        checksum/extra-secrets: e9582fdd622296c976cbc10a5ba7d6702c28a24fe80795ea5b84ba443a56c827
        checksum/metadata-secret: 1527346545415bf13f4c9ad69470086eb90d854f2b83594d78ec1badb5e13eb0
        checksum/pgbouncer-config-secret: 1dae2adc757473469686d37449d076b0c82404f61413b58ae68b3c5e99527688
        checksum/webserver-config: 2f3fdfd294a37094d2abee43b2b09888a5c195ee03414996bf99a4681658af94
        checksum/webserver-secret-key: 4b01f1b2b328f77abd00894f0618fd2c64e31116169424a1178c1954f7b47489
      labels:
        component: webserver
        release: airflow
        tier: airflow
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: webserver
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - args:
        - bash
        - -c
        - exec airflow webserver
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: airflow-fernet-key
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: airflow-webserver-secret-key
        envFrom: []
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
        name: webserver
        ports:
        - containerPort: 8080
          name: airflow-ui
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        startupProbe:
          failureThreshold: 6
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          periodSeconds: 10
          timeoutSeconds: 20
        volumeMounts:
        - mountPath: /opt/airflow/pod_templates/pod_template_file.yaml
          name: config
          readOnly: true
          subPath: pod_template_file.yaml
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      initContainers:
      - args:
        - airflow
        - db
        - check-migrations
        - --migration-wait-timeout=60
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: airflow-fernet-key
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: airflow-webserver-secret-key
        envFrom: []
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        name: wait-for-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: airflow-webserver
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: airflow-config
        name: config
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/version: 16.1.0
    helm.sh/chart: postgresql-13.2.24
  name: airflow-postgresql
  namespace: airflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: primary
      app.kubernetes.io/instance: airflow
      app.kubernetes.io/name: postgresql
  serviceName: airflow-postgresql-hl
  template:
    metadata:
      labels:
        app.kubernetes.io/component: primary
        app.kubernetes.io/instance: airflow
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: postgresql
        app.kubernetes.io/version: 16.1.0
        helm.sh/chart: postgresql-13.2.24
      name: airflow-postgresql
    spec:
      affinity:
        nodeAffinity: null
        podAffinity: null
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: primary
                  app.kubernetes.io/instance: airflow
                  app.kubernetes.io/name: postgresql
              topologyKey: kubernetes.io/hostname
            weight: 1
      containers:
      - env:
        - name: BITNAMI_DEBUG
          value: "false"
        - name: POSTGRESQL_PORT_NUMBER
          value: "5432"
        - name: POSTGRESQL_VOLUME_DIR
          value: /bitnami/postgresql
        - name: PGDATA
          value: /bitnami/postgresql/data
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              key: postgres-password
              name: airflow-postgresql
        - name: POSTGRESQL_ENABLE_LDAP
          value: "no"
        - name: POSTGRESQL_ENABLE_TLS
          value: "no"
        - name: POSTGRESQL_LOG_HOSTNAME
          value: "false"
        - name: POSTGRESQL_LOG_CONNECTIONS
          value: "false"
        - name: POSTGRESQL_LOG_DISCONNECTIONS
          value: "false"
        - name: POSTGRESQL_PGAUDIT_LOG_CATALOG
          value: "off"
        - name: POSTGRESQL_CLIENT_MIN_MESSAGES
          value: error
        - name: POSTGRESQL_SHARED_PRELOAD_LIBRARIES
          value: pgaudit
        image: docker.io/bitnami/postgresql:16.1.0-debian-11-r15
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - exec pg_isready -U "postgres" -h 127.0.0.1 -p 5432
          failureThreshold: 6
          initialDelaySeconds: 30
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        name: postgresql
        ports:
        - containerPort: 5432
          name: tcp-postgresql
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - -e
            - |
              exec pg_isready -U "postgres" -h 127.0.0.1 -p 5432
              [ -f /opt/bitnami/postgresql/tmp/.initialized ] || [ -f /bitnami/postgresql/.initialized ]
          failureThreshold: 6
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        resources:
          limits: {}
          requests:
            cpu: 250m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          privileged: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 1001
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - mountPath: /dev/shm
          name: dshm
        - mountPath: /bitnami/postgresql
          name: data
      hostIPC: false
      hostNetwork: false
      securityContext:
        fsGroup: 1001
      serviceAccountName: default
      volumes:
      - emptyDir:
          medium: Memory
        name: dshm
  updateStrategy:
    rollingUpdate: {}
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 8Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    chart: airflow-1.15.0
    component: triggerer
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-triggerer
spec:
  replicas: 1
  selector:
    matchLabels:
      component: triggerer
      release: airflow
      tier: airflow
  serviceName: airflow-triggerer
  template:
    metadata:
      annotations:
        checksum/airflow-config: dc80aa0b8f9153165322df3c9b27cc36d75ad7f07eb5c06abe4f2f22f2490932
        checksum/extra-configmaps: e862ea47e13e634cf17d476323784fa27dac20015550c230953b526182f5cac8
        checksum/extra-secrets: e9582fdd622296c976cbc10a5ba7d6702c28a24fe80795ea5b84ba443a56c827
        checksum/metadata-secret: 1527346545415bf13f4c9ad69470086eb90d854f2b83594d78ec1badb5e13eb0
        checksum/pgbouncer-config-secret: 1dae2adc757473469686d37449d076b0c82404f61413b58ae68b3c5e99527688
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
      labels:
        component: triggerer
        release: airflow
        tier: airflow
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: triggerer
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - args:
        - bash
        - -c
        - exec airflow triggerer
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: airflow-fernet-key
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: airflow-webserver-secret-key
        envFrom: []
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              CONNECTION_CHECK_MAX_COUNT=0 AIRFLOW__LOGGING__LOGGING_LEVEL=ERROR exec /entrypoint \
              airflow jobs check --job-type TriggererJob --local
          failureThreshold: 5
          initialDelaySeconds: 10
          periodSeconds: 60
          timeoutSeconds: 20
        name: triggerer
        ports:
        - containerPort: 8794
          name: triggerer-logs
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/logs
          name: logs
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
        - mountPath: /opt/airflow/dags
          name: dags
          readOnly: true
      - env:
        - name: GIT_SSH_KEY_FILE
          value: /etc/git-secret/ssh
        - name: GITSYNC_SSH_KEY_FILE
          value: /etc/git-secret/ssh
        - name: GIT_SYNC_SSH
          value: "true"
        - name: GITSYNC_SSH
          value: "true"
        - name: GIT_KNOWN_HOSTS
          value: "false"
        - name: GITSYNC_SSH_KNOWN_HOSTS
          value: "false"
        - name: GIT_SYNC_REV
          value: HEAD
        - name: GITSYNC_REF
          value: v2-2-stable
        - name: GIT_SYNC_BRANCH
          value: main
        - name: GIT_SYNC_REPO
          value: https://github.com/ankiyong/seoul_traffic.git
        - name: GITSYNC_REPO
          value: https://github.com/ankiyong/seoul_traffic.git
        - name: GIT_SYNC_DEPTH
          value: "1"
        - name: GITSYNC_DEPTH
          value: "1"
        - name: GIT_SYNC_ROOT
          value: /git
        - name: GITSYNC_ROOT
          value: /git
        - name: GIT_SYNC_DEST
          value: repo
        - name: GITSYNC_LINK
          value: repo
        - name: GIT_SYNC_ADD_USER
          value: "true"
        - name: GITSYNC_ADD_USER
          value: "true"
        - name: GITSYNC_PERIOD
          value: 5s
        - name: GIT_SYNC_MAX_SYNC_FAILURES
          value: "0"
        - name: GITSYNC_MAX_FAILURES
          value: "0"
        envFrom: []
        image: registry.k8s.io/git-sync/git-sync:v4.1.0
        imagePullPolicy: IfNotPresent
        name: git-sync
        resources: {}
        securityContext:
          runAsUser: 65533
        volumeMounts:
        - mountPath: /git
          name: dags
        - mountPath: /etc/git-secret/ssh
          name: git-sync-ssh-key
          readOnly: true
          subPath: gitSshKey
      - args:
        - bash
        - /clean-logs
        env:
        - name: AIRFLOW__LOG_RETENTION_DAYS
          value: "15"
        - name: AIRFLOW_HOME
          value: /opt/airflow
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        name: triggerer-log-groomer
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/logs
          name: logs
      initContainers:
      - args:
        - airflow
        - db
        - check-migrations
        - --migration-wait-timeout=60
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: airflow-fernet-key
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: airflow-webserver-secret-key
        envFrom: []
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        name: wait-for-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      - env:
        - name: GIT_SSH_KEY_FILE
          value: /etc/git-secret/ssh
        - name: GITSYNC_SSH_KEY_FILE
          value: /etc/git-secret/ssh
        - name: GIT_SYNC_SSH
          value: "true"
        - name: GITSYNC_SSH
          value: "true"
        - name: GIT_KNOWN_HOSTS
          value: "false"
        - name: GITSYNC_SSH_KNOWN_HOSTS
          value: "false"
        - name: GIT_SYNC_REV
          value: HEAD
        - name: GITSYNC_REF
          value: v2-2-stable
        - name: GIT_SYNC_BRANCH
          value: main
        - name: GIT_SYNC_REPO
          value: https://github.com/ankiyong/seoul_traffic.git
        - name: GITSYNC_REPO
          value: https://github.com/ankiyong/seoul_traffic.git
        - name: GIT_SYNC_DEPTH
          value: "1"
        - name: GITSYNC_DEPTH
          value: "1"
        - name: GIT_SYNC_ROOT
          value: /git
        - name: GITSYNC_ROOT
          value: /git
        - name: GIT_SYNC_DEST
          value: repo
        - name: GITSYNC_LINK
          value: repo
        - name: GIT_SYNC_ADD_USER
          value: "true"
        - name: GITSYNC_ADD_USER
          value: "true"
        - name: GITSYNC_PERIOD
          value: 5s
        - name: GIT_SYNC_MAX_SYNC_FAILURES
          value: "0"
        - name: GITSYNC_MAX_FAILURES
          value: "0"
        - name: GIT_SYNC_ONE_TIME
          value: "true"
        - name: GITSYNC_ONE_TIME
          value: "true"
        envFrom: []
        image: registry.k8s.io/git-sync/git-sync:v4.1.0
        imagePullPolicy: IfNotPresent
        name: git-sync-init
        resources: {}
        securityContext:
          runAsUser: 65533
        volumeMounts:
        - mountPath: /git
          name: dags
        - mountPath: /etc/git-secret/ssh
          name: git-sync-ssh-key
          readOnly: true
          subPath: gitSshKey
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: airflow-triggerer
      terminationGracePeriodSeconds: 60
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: airflow-config
        name: config
      - emptyDir: {}
        name: dags
      - name: git-sync-ssh-key
        secret:
          defaultMode: 288
          secretName: airflow-git-ssh-secret
  volumeClaimTemplates:
  - metadata:
      name: logs
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
    helm.sh/hook-weight: "2"
  labels:
    chart: airflow-1.15.0
    component: create-user-job
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-create-user
spec:
  template:
    metadata:
      labels:
        component: create-user-job
        release: airflow
        tier: airflow
    spec:
      affinity: {}
      containers:
      - args:
        - bash
        - -c
        - |-
          exec \
          airflow users create "$@"
        - --
        - -r
        - Admin
        - -u
        - admin
        - -e
        - admin@example.com
        - -f
        - admin
        - -l
        - user
        - -p
        - admin
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: airflow-fernet-key
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: airflow-webserver-secret-key
        envFrom: []
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        name: create-user
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: OnFailure
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: airflow-create-user-job
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: airflow-config
        name: config
  ttlSecondsAfterFinished: 300
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
    helm.sh/hook-weight: "1"
  labels:
    chart: airflow-1.15.0
    component: run-airflow-migrations
    heritage: Helm
    release: airflow
    tier: airflow
  name: airflow-run-airflow-migrations
spec:
  template:
    metadata:
      labels:
        component: run-airflow-migrations
        release: airflow
        tier: airflow
    spec:
      affinity: {}
      containers:
      - args:
        - bash
        - -c
        - |-
          exec \
          airflow db migrate
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: airflow-fernet-key
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: airflow-webserver-secret-key
        envFrom: []
        image: apache/airflow:2.9.3
        imagePullPolicy: IfNotPresent
        name: run-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: OnFailure
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: airflow-migrate-database-job
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: airflow-config
        name: config
  ttlSecondsAfterFinished: 300
